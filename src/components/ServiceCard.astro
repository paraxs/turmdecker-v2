---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

interface Props {
  title: string;
  href: string;
  altText: string;
  images?: ImageMetadata[];
  imagePath?: ImageMetadata;
}

const CAROUSEL_ENABLED = true;

const { title, href: rawHref, altText, images, imagePath } = Astro.props as Props;

function normalizeInternalHref(input: string) {
  const s = (input ?? "").trim();
  if (!s) return "/";

  // extern / special schemes nicht anfassen
  if (/^(https?:)?\/\//i.test(s) || /^(mailto:|tel:|sms:)/i.test(s)) return s;

  // Hash-only nicht anfassen
  if (s.startsWith("#")) return s;

  // Query/Hash abtrennen
  const m = s.match(/^([^?#]*)(.*)$/);
  const pathPart = m ? m[1] : s;
  const suffix = m ? m[2] : "";

  const withLeading = pathPart.startsWith("/") ? pathPart : `/${pathPart}`;

  if (withLeading === "/") return "/" + suffix;

  const withTrailing = withLeading.replace(/\/?$/, "/");
  return withTrailing + suffix;
}

const href = normalizeInternalHref(rawHref);

const slides = (images?.length ? images : imagePath ? [imagePath] : []).slice(0, 4);
const hasCarousel = CAROUSEL_ENABLED && slides.length > 1;

const uid =
  "tdc-" + (href || title).toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");

const SIZES = "(min-width: 1024px) 33vw, (min-width: 640px) 50vw, 100vw";
---

<article class="group h-full bg-white flex flex-col shadow-sm hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-1 overflow-hidden rounded-sm relative">
  <div class="relative w-full aspect-[4/3] overflow-hidden bg-gray-200">
    {hasCarousel ? (
      <div class="tdc" data-td-carousel data-uid={uid} data-count={slides.length}>
        <button type="button" class="tdc-btn tdc-prev" aria-label="Vorheriges Bild">‹</button>

        <div class="tdc-viewport" tabindex="0" aria-label={`${title} Bilder`}>
          <div class="tdc-track">
            {slides.map((img, i) => (
		  <div class="tdc-slide">
			<a href={href} class="tdc-slideLink" aria-label={`${title} öffnen`}>
			  <Image
				src={img}
				alt={i === 0 ? altText : ""}
				width={900}
				height={675}
				widths={[320, 480, 640, 768, 900]}
				sizes={SIZES}
				fit="cover"
				position="center"
				loading="lazy"
				decoding="async"
				class="tdc-img"
				quality={70}
			  />
			</a>
		  </div>
		))}
          </div>
        </div>

        <button type="button" class="tdc-btn tdc-next" aria-label="Nächstes Bild">›</button>

        <div class="tdc-dots" aria-label="Bildauswahl">
		  {slides.map((_, i) => (
			<button
			  type="button"
			  class={"tdc-dot" + (i === 0 ? " is-active" : "")}
			  data-dot={i}
			  aria-label={`Bild ${i + 1}`}
			></button>
		  ))}
		</div>

        
      </div>
    ) : slides[0] ? (
      <a href={href} aria-label={`${title} öffnen`} class="block w-full h-full">
        <Image
          src={slides[0]}
          alt={altText}
          width={900}
          height={675}
          widths={[320, 480, 640, 768, 900]}
          sizes={SIZES}
          fit="cover"
          position="center"
          loading="lazy"
          decoding="async"
          class="w-full h-full object-cover block"
          quality={70}
        />
      </a>
    ) : null}

    <div class="absolute inset-0 bg-primary/0 group-hover:bg-primary/15 transition-colors duration-300 pointer-events-none"></div>
  </div>

  <a
    href={href}
    class="p-8 flex-grow flex flex-col justify-between border-b-4 border-transparent group-hover:border-primary transition-colors"
    aria-label={`${title} öffnen`}
  >
    <div>
      <h3 class="text-xl font-bold uppercase tracking-tight text-dark-900 group-hover:text-primary transition-colors mb-4">
        {title}
      </h3>
      <div class="w-12 h-1 bg-gray-200 group-hover:bg-primary transition-colors mb-4"></div>
    </div>

    <span class="text-xs font-bold text-gray-400 group-hover:text-dark-900 uppercase tracking-widest self-end mt-4">
      Mehr erfahren &rarr;
    </span>
  </a>
</article>

<style is:global>
  .tdc{ position:relative; width:100%; height:100%; }
  .tdc-slideLink{
    display:block;
    width:100%;
    height:100%;
	}
  .tdc-viewport{
    width:100%;
    height:100%;
    overflow-x:auto;
    overflow-y:hidden;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    cursor: pointer;
	cursor: grab;
	touch-action: pan-y; /* vertikales Page-Scroll bleibt, horizontal im Container */
	user-select: none;
	}
  .tdc-viewport.is-dragging{
	  cursor: grabbing;
	}
  .tdc-slideLink, .tdc-img{
	  -webkit-user-drag: none;
	  }
  .tdc-viewport::-webkit-scrollbar{ display:none; }
  .tdc-track{ display:flex; height:100%; gap:0; }
  .tdc-slide{ flex:0 0 100%; height:100%; scroll-snap-align:start; }

  .tdc-slide img,
  .tdc-slide picture{
    width:100%;
    height:100%;
    display:block;
  }
  .tdc-slide img{ object-fit:cover; }

  .tdc-btn{
    position:absolute;
    top:50%;
    transform: translateY(-50%);
    z-index:5;
    width:38px;
    height:38px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.35);
    background: rgba(0,0,0,.35);
    color:#fff;
    font-size:22px;
    line-height:38px;
    text-align:center;
    cursor:pointer;
    opacity:0;
    transition: opacity .25s ease, background-color .25s ease, transform .25s ease;
    user-select:none;
  }
  .tdc-prev{ left:10px; }
  .tdc-next{ right:10px; }

  .group:hover .tdc-btn,
  .group:focus-within .tdc-btn{ opacity:.95; }
  .tdc-btn:hover{ background: rgba(0,0,0,.55); }

  @media (max-width: 639px){
    .tdc-btn{ opacity:.75; }
  }

  /* Dots: als echte Buttons (klickbar) */
  .tdc-dots{
    position:absolute;
    left:50%;
    bottom:10px;
    transform: translateX(-50%);
    display:flex;
    gap:6px;
    z-index:6;
    opacity:.9;
  }
  .tdc-dot{
    width:10px; height:10px;
    border-radius:999px;
    background: rgba(255,255,255,.55);
    border:1px solid rgba(0,0,0,.12);
    cursor:pointer;
    padding:0;
  }
  .tdc-dot.is-active{ background: rgba(255,255,255,.95); }

  .tdc-open{
    position:absolute;
    right:10px;
    top:10px;
    z-index:7;
    width:34px;
    height:34px;
    border-radius:999px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:700;
    border:1px solid rgba(255,255,255,.35);
    background: rgba(0,0,0,.35);
    text-decoration:none;
    opacity:.0;
    transition: opacity .25s ease, background-color .25s ease;
  }
  .group:hover .tdc-open,
  .group:focus-within .tdc-open{ opacity:.95; }
  .tdc-open:hover{ background: rgba(0,0,0,.55); }

  @media (prefers-reduced-motion: reduce){
    .tdc-viewport{ scroll-behavior:auto; }
  }
</style>
