---
import "../styles/global.css";
import { ViewTransitions } from "astro:transitions";

import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import WhatsAppBtn from "../components/WhatsAppBtn.astro";

interface Props {
  title: string;
  description?: string;
  noindex?: boolean;
  ogImage?: string;
  hideHeader?: boolean;
  hideFooter?: boolean;
  hideWhatsApp?: boolean;
}

const {
  title,
  description,
  noindex,
  ogImage,
  hideHeader = false,
  hideFooter = false,
  hideWhatsApp = false,
} = Astro.props as Props;

// --- Canonical (Trailing Slash erzwingen) ---
const rawPath = Astro.url.pathname;
const canonicalPath = rawPath === "/" ? "/" : rawPath.replace(/\/?$/, "/");
const canonical = Astro.site ? new URL(canonicalPath, Astro.site).href : null;

// --- Meta Description ---
const desc = description ?? "Turmdecker - Gerüstfreies Kirchturmdecken";

// --- Slots (nicht kaputt-optimieren) ---
const hasHeaderSlot = Astro.slots.has("header");
const hasFooterSlot = Astro.slots.has("footer");

// --- Absolut-URL Helper ---
const site = Astro.site ?? new URL("https://turmdecker.com/");
const abs = (pathOrUrl: string) => new URL(pathOrUrl, site).href;

// --- Default Bild für strukturierte Daten ---
const structuredImage = abs("/hero/hero-03.webp");

// --- JSON-LD (nur Austria, kein sameAs) ---
const orgSchema = {
  "@context": "https://schema.org",
  "@type": "RoofingContractor",
  "@id": `${site.href.replace(/\/?$/, "/")}#business`,
  name: "Turmdecker – Kofler e.U.",
  url: site.href.replace(/\/?$/, "/"),
  logo: abs("/favicon.svg"),
  image: structuredImage,
  description:
    "Gerüstfreies Kirchturmdecken und Spezialarbeiten am Seil – Lärchenschindeln, Kupfer, Schiefer. Österreichweit, grenzüberschreitend nach Bedarf.",
  telephone: "+43 664 4328298",
  email: "office@turmdecker.com",
  address: {
    "@type": "PostalAddress",
    streetAddress: "Peggetzstraße 20",
    postalCode: "9900",
    addressLocality: "Lienz",
    addressRegion: "Tirol",
    addressCountry: "AT",
  },
  founder: { "@type": "Person", name: "Franz Kofler" },
  areaServed: [{ "@type": "Country", name: "Austria" }],
};
---

<!doctype html>
<html lang="de-AT" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- CD Farbe für Browser UI / Mobile -->
    <meta name="theme-color" content="#8F1D1D" />

    <title>{title}</title>
    <meta name="description" content={desc} />

    <!-- Canonical nur wenn site gesetzt ist -->
    {canonical && <link rel="canonical" href={canonical} />}

    {noindex && <meta name="robots" content="noindex,nofollow" />}

    <!-- Social Preview -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={desc} />
    {canonical && <meta property="og:url" content={canonical} />}
    {ogImage && (
      <meta
        property="og:image"
        content={Astro.site ? new URL(ogImage, Astro.site).href : ogImage}
      />
    )}

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={desc} />
    {ogImage && (
      <meta
        name="twitter:image"
        content={Astro.site ? new URL(ogImage, Astro.site).href : ogImage}
      />
    )}

    <!-- Favicons (stabil, Google-kompatibel) -->
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
    <link rel="manifest" href="/site.webmanifest" />

    <!-- View Transitions (App-Feeling). Wenn irgendwas spinnt: diese Zeile raus. -->
    <ViewTransitions />

    <slot name="head" />

    <!-- JSON-LD: Business-Schema nur auf der Startseite -->
    {Astro.url.pathname === "/" && (
      <script type="application/ld+json" set:html={JSON.stringify(orgSchema)}></script>
    )}
  </head>

  <body class="bg-white text-gray-900 font-sans antialiased">
    {!hideHeader && (hasHeaderSlot ? <slot name="header" /> : <Header />)}

    <main>
      <slot />
    </main>

    {!hideFooter && (hasFooterSlot ? <slot name="footer" /> : <Footer />)}

    {!hideWhatsApp && <WhatsAppBtn />}

    <script src="/td-carousel.js" defer></script>
	
  </body>
</html>
